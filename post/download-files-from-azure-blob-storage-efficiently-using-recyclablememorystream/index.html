<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <script type="application/ld+json">

{  
  "@context":"http://schema.org",
  "@type":"Website",
  "@id":"https:\/\/anktsrkr.github.io\/",
  "author": {
    "@type": "Person",
    "name": "Ankit Sarkar | .NET Enthusiast | Azure Cloud Practitioner",
    
    "image": "https://www.gravatar.com/avatar/95b5dbc23a1aea8bc95d53efd0a30edf"
    
  },
  "name":"Ankit Sarkar | .NET Enthusiast | Azure Cloud Practitioner",
  "description":"Download Files From Azure Blob Storage Efficiently Using RecyclableMemoryStream",
  "url":"https:\/\/anktsrkr.github.io\/post\/download-files-from-azure-blob-storage-efficiently-using-recyclablememorystream\/",
  "keywords":"[azure storage recyclablememorystream, azure storage recyclablememorystream manager, azure storage .net 7, azure storage azurite, azure storage azurite recyclablememorystream, azure storage azurite recyclablememorystream manager, azure storage azurite memory optimized, azure storage blob recyclablememorystream, azure storage blob recyclablememorystream manager, azure storage blob memory optimized, azure storage blob xunit, azure storage blob .net 7, BlobContainerClient, BlobContainerClient dependency injection, BlobClient, BlobServiceClient, Azure.Storage.Blobs, Azure.Storage.Blobs v12 unit testing, Azure.Storage.Blobs v12 integration testing, Dependency injection, azure storage blob dependency injection, azure storage dependency injection, azure storage testing, azurite, moving solutions to Azure Cloud, How to download files memory optimized way from azure blob storage, How to download files memory optimized way from azure blob storage using recyclablememorystream, How to use RecyclableMemoryStream in .NET Core, Microsoft.IO.RecyclableMemoryStream, Take advantage of Microsoft.IO.RecyclableMemoryStream to eliminate LOH allocations and avoid memory fragmentation and memory leaks in your .NET Core applications., RecyclableMemoryStream, RecyclableMemoryStream Manager, Recyclable Memory Stream, .net core Recyclable Memory Stream, .net core Recyclable Memory Stream manager]"
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.74.3 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="Ankit Sarkar | .NET Enthusiast | Azure Cloud Practitioner">
<meta name="keywords" content="azure storage recyclablememorystream, azure storage recyclablememorystream manager, azure storage .net 7, azure storage azurite, azure storage azurite recyclablememorystream, azure storage azurite recyclablememorystream manager, azure storage azurite memory optimized, azure storage blob recyclablememorystream, azure storage blob recyclablememorystream manager, azure storage blob memory optimized, azure storage blob xunit, azure storage blob .net 7, BlobContainerClient, BlobContainerClient dependency injection, BlobClient, BlobServiceClient, Azure.Storage.Blobs, Azure.Storage.Blobs v12 unit testing, Azure.Storage.Blobs v12 integration testing, Dependency injection, azure storage blob dependency injection, azure storage dependency injection, azure storage testing, azurite, moving solutions to Azure Cloud, How to download files memory optimized way from azure blob storage, How to download files memory optimized way from azure blob storage using recyclablememorystream, How to use RecyclableMemoryStream in .NET Core, Microsoft.IO.RecyclableMemoryStream, Take advantage of Microsoft.IO.RecyclableMemoryStream to eliminate LOH allocations and avoid memory fragmentation and memory leaks in your .NET Core applications., RecyclableMemoryStream, RecyclableMemoryStream Manager, Recyclable Memory Stream, .net core Recyclable Memory Stream, .net core Recyclable Memory Stream manager">
<meta name="description" content="Download Files From Azure Blob Storage Efficiently Using RecyclableMemoryStream">


<meta property="og:description" content="Download Files From Azure Blob Storage Efficiently Using RecyclableMemoryStream">
<meta property="og:type" content="article">
<meta property="og:title" content="Download Files From Azure Blob Storage Efficiently Using RecyclableMemoryStream">
<meta name="twitter:title" content="Download Files From Azure Blob Storage Efficiently Using RecyclableMemoryStream">
<meta property="og:url" content="https://anktsrkr.github.io/post/download-files-from-azure-blob-storage-efficiently-using-recyclablememorystream/">
<meta property="twitter:url" content="https://anktsrkr.github.io/post/download-files-from-azure-blob-storage-efficiently-using-recyclablememorystream/">
<meta property="og:site_name" content="Ankit Sarkar | .NET Enthusiast | Azure Cloud Practitioner">
<meta property="og:description" content="Download Files From Azure Blob Storage Efficiently Using RecyclableMemoryStream">
<meta name="twitter:description" content="Download Files From Azure Blob Storage Efficiently Using RecyclableMemoryStream">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2023-05-24T06:00:35">
  
  
    <meta property="article:modified_time" content="2023-05-24T06:00:35">
  
  
  
    
      <meta property="article:section" content="Azure">
    
      <meta property="article:section" content="Azurite">
    
      <meta property="article:section" content=".NET 7">
    
  
  
    
      <meta property="article:tag" content="azure">
    
      <meta property="article:tag" content="c#">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@anktsrkr">


  <meta name="twitter:creator" content="@anktsrkr">










  <meta property="og:image" content="https://anktsrkr.github.io/images/azstorage/azure-storage-blob.png">
  <meta property="twitter:image" content="https://anktsrkr.github.io/images/azstorage/azure-storage-blob.png">


  <meta property="og:image" content="https://www.gravatar.com/avatar/95b5dbc23a1aea8bc95d53efd0a30edf?s=640">
  <meta property="twitter:image" content="https://www.gravatar.com/avatar/95b5dbc23a1aea8bc95d53efd0a30edf?s=640">

    <title>Download Files From Azure Blob Storage Efficiently Using RecyclableMemoryStream</title>

    <link rel="icon" href="https://anktsrkr.github.io/favicon.png">
    

    

    <link rel="canonical" href="https://anktsrkr.github.io/post/download-files-from-azure-blob-storage-efficiently-using-recyclablememorystream/">

    
    <link rel="preload"  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet"  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer"></noscript>
    
   
    <link rel="stylesheet" rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://anktsrkr.github.io/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css"/>
    
    
    

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-176781214-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    <link rel="manifest" href="https://anktsrkr.github.io/manifest.json">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2534759648571863"
     crossorigin="anonymous"></script>
     
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TY8ZMTBGSM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TY8ZMTBGSM');
</script>
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://anktsrkr.github.io/" aria-label="Go to homepage">Ankit Sarkar | .NET Enthusiast | Azure Cloud Practitioner</a>
  </div>
  
    
      <a class="header-right-picture "
         href="https://anktsrkr.github.io/#about" aria-label="Open the link: /#about">
    
    
    
      
        <img class="header-picture" src="https://www.gravatar.com/avatar/95b5dbc23a1aea8bc95d53efd0a30edf?s=90" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://anktsrkr.github.io/#about" aria-label="Read more about the author">
          <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/95b5dbc23a1aea8bc95d53efd0a30edf?s=110" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Ankit Sarkar | .NET Enthusiast | Azure Cloud Practitioner</h4>
        
          <h5 class="sidebar-profile-bio"><strong>Technical Architect, Microsoft Certified Azure Solutions Architect Expert</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://anktsrkr.github.io/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://anktsrkr.github.io/categories" title="Categories">
    
      <i class="sidebar-button-icon fas fa-lg fa-bookmark" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://anktsrkr.github.io/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://anktsrkr.github.io/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://anktsrkr.github.io/about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/anktsrkr" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.linkedin.com/in/ankit-sarkar/" target="_blank" rel="noopener" title="Linkedin">
    
      <i class="sidebar-button-icon fab fa-lg fa-linkedin" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Linkedin</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/ankt_srkr" target="_blank" rel="noopener" title="Twitter">
    
      <i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://anktsrkr.github.io/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="5"
        class="
               hasCoverMetaIn
               ">
        <article class="post" id="top">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title">
      Download Files From Azure Blob Storage Efficiently Using RecyclableMemoryStream
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2023-05-24T06:00:35&#43;01:00">
        
  May 24, 2023

      </time>
    
    
  
  
    <span>in</span>
    
      <a class="category-link" href="https://anktsrkr.github.io/categories/azure">Azure</a>, 
    
      <a class="category-link" href="https://anktsrkr.github.io/categories/azurite">Azurite</a>, 
    
      <a class="category-link" href="https://anktsrkr.github.io/categories/.net-7">.NET 7</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p>Recently, I was working on a project where we had to download multiple large files from Azure Blob Storage and process it further. When the application hits the production environment and started getting the actual files, we observed that memory consumption is getting very high. On top of that, the application was hosted in shared windows based app service plan, which was making it even worse for other applications too.</p>
<p>After analyzing the issue, we found that the issue was with the way we were downloading the files. In this post, we will see how we can download files from Azure Blob Storage efficiently using <strong><span class="highlight-text orange">RecyclableMemoryStream</span></strong>.</p>
<h2 id="the-problem">The Problem</h2>
<p>Let us first understand the problem. In this section, we will see how we were downloading the files from Azure Blob Storage. Below is the code snippet for the same.</p>

  
    
  
  
    
  
  
  


<figure class="highlight csharp language-csharp">
  <figcaption>
    
      <span>AzBlobService.cs</span>
    
  </figcaption>
  <table>
    <tbody>
      <tr>
        <td class="gutter">
          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
        </td>
        <td class="code">
          <pre class="code-highlight language-csharp csharp"><code class="csharp">public async Task&lt;bool&gt; DownloadFileFromAzBlobNotOptimizedAsync()
    {
        var container = _blobServiceClient.GetBlobContainerClient(_azBlobSettingsOption.ContainerName);
        var blobs = container.GetBlobs();
        foreach (var blob in blobs)
        {
                try
                {
                    var blobClient = container.GetBlobClient(blob.Name);
                    using var stream = new MemoryStream();
                    await blobClient.DownloadToAsync(stream);
                }
                finally
                {
                }
        }
        return true;
    }</code></pre>
        </td>
      </tr>
    </tbody>
  </table>
</figure>

<p>Above code snippet is self explanatory but let me explain it in detail. We are using <strong><span class="highlight-text blue">BlobServiceClient</span></strong> to get the list of blobs from the container. Then we are looping through the blob&rsquo;s metadata and downloading the files <em>one by one</em>.</p>
<p>Let us benchmark the above code snippet using <strong><span class="highlight-text green">BenchmarkDotNet</span></strong>. Below is the code snippet for the same.</p>

  
    
  
  
    
  
  
  


<figure class="highlight csharp language-csharp">
  <figcaption>
    
      <span>Program.cs</span>
    
  </figcaption>
  <table>
    <tbody>
      <tr>
        <td class="gutter">
          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre>
        </td>
        <td class="code">
          <pre class="code-highlight language-csharp csharp"><code class="csharp">internal class ProgramX
{
    private static void Main(string[] args)
    {
        var summary = BenchmarkRunner.Run&lt;BenchmarkAPIPerformance&gt;();
    }
}

[MemoryDiagnoser]
[ThreadingDiagnoser]
public class BenchmarkAPIPerformance
{
    private static HttpClient _httpClient;

    [Params(25,50)]
    public int N;

    [GlobalSetup]
    public void GlobalSetup()
    {
        var factory = new WebApplicationFactory&lt;Program&gt;()
                    .WithWebHostBuilder(_ =&gt;{});
        _httpClient = factory.CreateClient();
    }

    [Benchmark]
    public async Task DownloadNotOptimized()
    {
        for (int i = 0; i &lt; N; i&#43;&#43;)
        {
            var response = await _httpClient.GetAsync(&#34;/DownloadNotOptimized&#34;);
        }</code></pre>
        </td>
      </tr>
    </tbody>
  </table>
</figure>

<p>Below is the benchmark result for the same.</p>
<figure>
    <img src="https://anktsrkr.github.io/images/azstorage/azblob-not-optimized.png"
         alt="Azure Blob Storage Not Optimized"/> 
</figure>

<p>If you see the above benchmark result, you will notice that Gen 0, Gen 1 and Gen 2 all has some value and also the memory allocation looks high. But what exactly is Gen 0, Gen 1 and Gen 2?</p>
<h3 id="what-is-gen-0-gen-1-and-gen-2">What is Gen 0, Gen 1 and Gen 2?</h3>
<p>I find the below explanation from Microsoft Docs <a href="https://learn.microsoft.com/en-us/dotnet/standard/garbage-collection/large-object-heap">LOH</a> and <a href="https://learn.microsoft.com/en-us/dotnet/standard/garbage-collection/fundamentals">Garbage Collection Fundamentals</a> very helpful.</p>
<p>The .NET garbage collector (GC) divides objects up into small and large objects. The small object heap (SOH) is used to store objects that are smaller than 85 KB in size. The large object heap (LOH) is used to store objects that are equal or larger than 85 KB in size.</p>
<p>The garbage collector is a generational collector. It has three generations: Gen 0, Gen 1, and Gen 2.</p>
<p>Gen 0 is the youngest generation and contains short-lived objects. An example of a short-lived object is a temporary variable. Garbage collection occurs most frequently in this generation.</p>
<p>Gen 1 contains short-lived objects and longer-lived objects. Examples of longer-lived objects are objects in server applications that contain static data that is live for the duration of the process.</p>
<p>Gen 2 contains longer-lived objects and survives garbage collection cycles longer than Gen 0 and Gen 1 objects. Examples of Gen 2 objects are objects in server applications that contain static data that is live for the duration of the process and large objects (85 KB or larger).</p>
<p>In our case, we are downloading the files and storing it in <strong><span class="highlight-text yellow">MemoryStream</span></strong>. Since the files are larger than 85 KB, surely it will end up in LOH.</p>
<h2 id="the-solution">The Solution</h2>
<p>So, from the above explanation, if we somehow can avoid LOH allocation, we might be able to reduce the memory consumption and performance will also improve. Microsoft has provided a library called <strong><span class="highlight-text orange">Microsoft.IO.RecyclableMemoryStream</span></strong> which can be used to avoid LOH allocation. The excellent documentation for the same can be found <a href="https://github.com/microsoft/Microsoft.IO.RecyclableMemoryStream">here</a> where you can find the details about how it actually works.</p>
<p>The best part is that the semantics are close to the original <strong><span class="highlight-text green">System.IO.MemoryStream</span></strong> implementation, and is intended to be a drop-in replacement as much as possible.</p>
<p>So, Let&rsquo;s try to implement in our code -</p>

  
    
  
  
    
  
  
  


<figure class="highlight csharp language-csharp">
  <figcaption>
    
      <span>AzBlobService.cs</span>
    
  </figcaption>
  <table>
    <tbody>
      <tr>
        <td class="gutter">
          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>
        </td>
        <td class="code">
          <pre class="code-highlight language-csharp csharp"><code class="csharp">private static readonly RecyclableMemoryStreamManager manager = new();
    public async Task&lt;bool&gt; DownloadFileFromAzBlobOptimizedAsync()
    {
        var container = _blobServiceClient.GetBlobContainerClient(_azBlobSettingsOption.ContainerName);
        var blobs = container.GetBlobs();
        foreach (var blob in blobs)
        {
            try
                {
                    var blobClient = container.GetBlobClient(blob.Name);
                    using var stream = manager.GetStream();
                    await blobClient.DownloadToAsync(stream);
                }
                finally
                {
                }
        }
        return true;
    }</code></pre>
        </td>
      </tr>
    </tbody>
  </table>
</figure>

<p>Note that <strong><span class="highlight-text orange">RecyclableMemoryStreamManager</span></strong> should be declared once and it will live for the entire process lifetime and it is thread safe. so, we can use it in multiple threads. let&rsquo;s update the code to download the files in parallel instead of sequentially.</p>

  
    
  
  
    
  
  
  


<figure class="highlight csharp language-csharp">
  <figcaption>
    
      <span>AzBlobService.cs</span>
    
  </figcaption>
  <table>
    <tbody>
      <tr>
        <td class="gutter">
          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre>
        </td>
        <td class="code">
          <pre class="code-highlight language-csharp csharp"><code class="csharp">public async Task&lt;bool&gt; DownloadFileFromAzBlobOptimizedAsync()
    {
        var container = _blobServiceClient.GetBlobContainerClient(_azBlobSettingsOption.ContainerName);
        var blobs = container.GetBlobs();
        var semaphore = new SemaphoreSlim(10);
        var tasks = new List&lt;Task&gt;();

        foreach (var blob in blobs)
        {
            await semaphore.WaitAsync();

            tasks.Add(Task.Run(async () =&gt;
            {
                try
                {
                    var blobClient = container.GetBlobClient(blob.Name);
                    using var stream = manager.GetStream();
                    await blobClient.DownloadToAsync(stream);
                }
                finally
                {
                    semaphore.Release();
                }
            }));
        }
        await Task.WhenAll(tasks);
        return true;
    }</code></pre>
        </td>
      </tr>
    </tbody>
  </table>
</figure>

<p>Here, <em>SemaphoreSlim</em> is used to limit the number of concurrent threads. In our case, we are limiting it to 10. You can change it as per your requirement.</p>
<p>Let&rsquo;s update the benchmark code to use the optimized version.</p>

  
    
  
  
    
  
  
  


<figure class="highlight csharp language-csharp">
  <figcaption>
    
      <span>Program.cs</span>
    
  </figcaption>
  <table>
    <tbody>
      <tr>
        <td class="gutter">
          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
        </td>
        <td class="code">
          <pre class="code-highlight language-csharp csharp"><code class="csharp">[Benchmark]
    public async Task DownloadOptimized()
    {
        for (int i = 0; i &lt; N; i&#43;&#43;)
        {
            var response = await _httpClient.GetAsync(&#34;/DownloadOptimized&#34;);
        }
    }</code></pre>
        </td>
      </tr>
    </tbody>
  </table>
</figure>

<p>Below is the benchmark result for the same.</p>
<figure>
    <img src="https://anktsrkr.github.io/images/azstorage/azblob-optimized.png"
         alt="Azure Blob Storage Optimized"/> 
</figure>

<h2 id="conclusion">Conclusion</h2>
<p>From the above result, we can clearly identify that there is a huge improvement in LOH allocation and becomes zero. This is possible because  <strong><span class="highlight-text orange">RecyclableMemoryStreamManager</span></strong> eliminate LOH allocations by using pooled buffers rather than pooling the streams themselves.</p>
<p>Also the memory allocation is reduced significantly. In fact, the memory allocation is reduced by ~734% which is huge.</p>
<p>You can find the source code <a href="https://github.com/sundryoss/Sundry.MsDemystified"><strong>here</strong></a>.</p>

              


            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://anktsrkr.github.io/tags/azure/">azure</a>

  <a class="tag tag--primary tag--small" href="https://anktsrkr.github.io/tags/c/">c#</a>

                  </div>
                
              
            
            
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://anktsrkr.github.io/post/re-authorize-efficiently-using-polly-and-httpclientfactory/" data-tooltip="Re-Authorize Efficiently Using Polly And .NET HttpClientFactory" aria-label="NEXT: Re-Authorize Efficiently Using Polly And .NET HttpClientFactory">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://anktsrkr.github.io/post/getting-started-with-testing-for-azure-blob-storage-mocking-blob-storage-sdk/" data-tooltip="Getting started with testing for Azure Blob Storage : Mocking Azure Blob/File Storage SDK" aria-label="PREVIOUS: Getting started with testing for Azure Blob Storage : Mocking Azure Blob/File Storage SDK">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://anktsrkr.github.io/post/download-files-from-azure-blob-storage-efficiently-using-recyclablememorystream/" title="Share on Facebook" aria-label="Share on Facebook">
          <i class="fab fa-facebook-square" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://anktsrkr.github.io/post/download-files-from-azure-blob-storage-efficiently-using-recyclablememorystream/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/sharing/share-offsite/?url=https://anktsrkr.github.io/post/download-files-from-azure-blob-storage-efficiently-using-recyclablememorystream/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
    <li class="post-action">
      <a class="post-action-btn btn btn--default" href="#disqus_thread" aria-label="Leave a comment">
        <i class="far fa-comment"></i>
      </a>
    </li>
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


            
  
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
    <script type="text/javascript">
      var disqus_config = function() {
        this.page.url = 'https:\/\/anktsrkr.github.io\/post\/download-files-from-azure-blob-storage-efficiently-using-recyclablememorystream\/';
        
          this.page.identifier = '\/post\/download-files-from-azure-blob-storage-efficiently-using-recyclablememorystream\/'
        
      };
      (function() {
        
        
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
          document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
          return;
        }
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        var disqus_shortname = 'anktsrkr-github-io';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
  


          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 Ankit Sarkar | .NET Enthusiast | Azure Cloud Practitioner. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://anktsrkr.github.io/post/re-authorize-efficiently-using-polly-and-httpclientfactory/" data-tooltip="Re-Authorize Efficiently Using Polly And .NET HttpClientFactory" aria-label="NEXT: Re-Authorize Efficiently Using Polly And .NET HttpClientFactory">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://anktsrkr.github.io/post/getting-started-with-testing-for-azure-blob-storage-mocking-blob-storage-sdk/" data-tooltip="Getting started with testing for Azure Blob Storage : Mocking Azure Blob/File Storage SDK" aria-label="PREVIOUS: Getting started with testing for Azure Blob Storage : Mocking Azure Blob/File Storage SDK">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://anktsrkr.github.io/post/download-files-from-azure-blob-storage-efficiently-using-recyclablememorystream/" title="Share on Facebook" aria-label="Share on Facebook">
          <i class="fab fa-facebook-square" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://anktsrkr.github.io/post/download-files-from-azure-blob-storage-efficiently-using-recyclablememorystream/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/sharing/share-offsite/?url=https://anktsrkr.github.io/post/download-files-from-azure-blob-storage-efficiently-using-recyclablememorystream/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
    <li class="post-action">
      <a class="post-action-btn btn btn--default" href="#disqus_thread" aria-label="Leave a comment">
        <i class="far fa-comment"></i>
      </a>
    </li>
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


      </div>
      
<div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <i id="btn-close-shareoptions" class="fa fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fanktsrkr.github.io%2Fpost%2Fdownload-files-from-azure-blob-storage-efficiently-using-recyclablememorystream%2F" aria-label="Share on Facebook">
          <i class="fab fa-facebook-square" aria-hidden="true"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fanktsrkr.github.io%2Fpost%2Fdownload-files-from-azure-blob-storage-efficiently-using-recyclablememorystream%2F" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fanktsrkr.github.io%2Fpost%2Fdownload-files-from-azure-blob-storage-efficiently-using-recyclablememorystream%2F" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i><span>Share on Linkedin</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>


    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.gravatar.com/avatar/95b5dbc23a1aea8bc95d53efd0a30edf?s=110" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Ankit Sarkar | .NET Enthusiast | Azure Cloud Practitioner</h4>
    
      <div id="about-card-bio"><strong>Technical Architect, Microsoft Certified Azure Solutions Architect Expert</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Technical Architect
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker-alt"></i>
        <br/>
        Nottingham
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://anktsrkr.github.io/images/cover.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/powershell.min.js"  crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://anktsrkr.github.io/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>


  
    <script async crossorigin="anonymous" defer integrity="sha512-gE8KAQyFIzV1C9+GZ8TKJHZS2s+n7EjNtC+IMRn1l5+WYJTHOODUM6JSjZhFhqXmc7bG8Av6XXpckA4tYhflnw==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/apache.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-EWROca+bote+7Oaaar1F6y74iZj1r1F9rm/ly7o+/FwJopbBaWtsFDmaKoZDd3QiGU2pGacBirHJNivmGLYrow==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/go.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-GDVzAn0wpx1yVtQsRWmFc6PhJiLBPdUic+h4GWgljBh904O3JU10fk9EKNpVyIoPqkFn54rgL2QBG4BmUTMpiQ==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/http.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-UgZlma8NzkrDb/NWgmLIcTrH7i/CSnLLDRFqCSNF5NGPpjKmzyM25qcoXGOup8+cDakKyaiTDd7N4dyH4YT+IA==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/less.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-lot9koe73sfXIrUvIPM/UEhuMciN56RPyBdOyZgfO53P2lkWyyXN7J+njcxIIBRV+nVDQeiWtiXg+bLAJZDTfg==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/nginx.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-Zd3e7XxHP00TD0Imr0PIfeM0fl0v95kMWuhyAS3Wn1UTSXTkz0OhtRgBAr4JlmADRgiXr4x7lpeUdqaGN8xIog==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/puppet.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-qtqDO052iXMSP+5d/aE/jMtL9vIIGvONgTJziC2K/ZIB1yEGa55WVxGE9/08rSQ62EoDifS9SWVGZ7ihSLhzMA==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/scss.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-1NmkjnEDnwwwcu28KoQF8vs3oaPFokQHbmbtwGhFfeDsQZtVFI8zW2aE9O8yMYdpdyKV/5blE4pSWw4Z/Sv97w==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/stylus.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-B2wSfruPjr8EJL6IIzQr1eAuDwrsfIfccNf/LCEdxELCgC/S/ZMt/Uvk80aD79m7IqOqW+Sw8nbkvha20yZpzg==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/swift.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-28oDiQZGKUVN6wQ7PSLPNipOcmkCALXKwOi7bnkyFf8QiMZQxG9EQoy/iiNx6Zxj2cG2SbVa4dXKigQhu7GiFw==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/yaml.min.js"></script>
  


<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightElement(block);
  });
});
</script>






<script>
    (function(w,d, s, id) {if(typeof(w.webpushr)!=='undefined') return;w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};var js, fjs = d.getElementsByTagName(s)[0];js = d.createElement(s); js.id = id;js.async=1;js.src = "https://cdn.webpushr.com/app.min.js";fjs.parentNode.appendChild(js);}(window,document, 'script', 'webpushr-jssdk'));webpushr('setup',{'key':'BEW0OG9D298JEOxVSTObrPp5nebohoFilULY8fRTJ4T-B8KfYk3G9nUAjtbqrX73vsvtkjGXfZNfsLWFz0xNew0' });
   </script>
   
   

<script>
    if('serviceWorker' in navigator) {
        navigator.serviceWorker
            .register('/sw.js', { scope: '/' })
            .then(function(registration) {
            });
  
        navigator.serviceWorker
            .ready
            .then(function(registration) {
            });
    }
  </script>
  
<script id="setmore_script" type="text/javascript" src="https://my.setmore.com/webapp/js/src/others/setmore_iframe.js">
</script>

<a id="Setmore_button_iframe" style="position: fixed;
 right: 20px;
 bottom: 15px;
 z-index: 9998;text-decoration: none"
    href="https://booking.setmore.com/scheduleappointment/d3cbc8af-7bd5-44c1-874b-87c9d77d82be">
    <div style="background: rgb(0, 105, 255); color: rgb(255, 255, 255);
display: table-cell;
width: auto;
height: 45px;
padding: 0 30px;
border-radius: 25px;
box-shadow: rgb(0 0 0 / 25%) 0 2px 5px;
font-family: sans-serif;
text-align: center;
vertical-align: middle;
font-weight: bold;
font-size: 14px;
color: #fff;
cursor: pointer;">#TalkWithMe</div>
</a>

    
  </body>
</html>

