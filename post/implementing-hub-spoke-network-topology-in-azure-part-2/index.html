<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <script type="application/ld+json">

{  
  "@context":"http://schema.org",
  "@type":"Website",
  "@id":"https:\/\/anktsrkr.github.io\/",
  "author": {
    "@type": "Person",
    "name": "Ankit Sarkar | .NET Enthusiast",
    
    "image": "https://www.gravatar.com/avatar/95b5dbc23a1aea8bc95d53efd0a30edf"
    
  },
  "name":"Ankit Sarkar | .NET Enthusiast",
  "description":"Implementing Hub-Spoke network topology in Azure",
  "url":"https:\/\/anktsrkr.github.io\/post\/implementing-hub-spoke-network-topology-in-azure-part-2\/",
  "keywords":"[hub, spoke,hub, spoke, network,hub, spoke, network, topology,azure, hub, spoke,azure, hub, spoke, network,azure, hub, spoke, network, topology, ,azure, firewall,connectivity, between, spoke,connectivity, between, spoke, vnet, using, azure, firewall,azure, powershell,Point, to, Site,, Site, to, Site,VPN]"
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.74.3 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="Ankit Sarkar | .NET Enthusiast">
<meta name="keywords" content="hub, spoke,hub, spoke, network,hub, spoke, network, topology,azure, hub, spoke,azure, hub, spoke, network,azure, hub, spoke, network, topology, ,azure, firewall,connectivity, between, spoke,connectivity, between, spoke, vnet, using, azure, firewall,azure, powershell,Point, to, Site,, Site, to, Site,VPN">
<meta name="description" content="Implementing Hub-Spoke network topology in Azure">


<meta property="og:description" content="Implementing Hub-Spoke network topology in Azure">
<meta property="og:type" content="article">
<meta property="og:title" content="Implementing Hub-Spoke network topology in Azure - Part 2">
<meta name="twitter:title" content="Implementing Hub-Spoke network topology in Azure - Part 2">
<meta property="og:url" content="https://anktsrkr.github.io/post/implementing-hub-spoke-network-topology-in-azure-part-2/">
<meta property="twitter:url" content="https://anktsrkr.github.io/post/implementing-hub-spoke-network-topology-in-azure-part-2/">
<meta property="og:site_name" content="Ankit Sarkar | .NET Enthusiast">
<meta property="og:description" content="Implementing Hub-Spoke network topology in Azure">
<meta name="twitter:description" content="Implementing Hub-Spoke network topology in Azure">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2020-09-08T01:00:00">
  
  
    <meta property="article:modified_time" content="2020-09-08T01:00:00">
  
  
  
    
      <meta property="article:section" content="Cloud">
    
      <meta property="article:section" content="Azure architecture">
    
      <meta property="article:section" content="Hub-Spoke Topology">
    
  
  
    
      <meta property="article:tag" content="Azure">
    
      <meta property="article:tag" content="Networking">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@anktsrkr">


  <meta name="twitter:creator" content="@anktsrkr">










  <meta property="og:image" content="https://anktsrkr.github.io/images/azure.png">
  <meta property="twitter:image" content="https://anktsrkr.github.io/images/azure.png">


  <meta property="og:image" content="https://www.gravatar.com/avatar/95b5dbc23a1aea8bc95d53efd0a30edf?s=640">
  <meta property="twitter:image" content="https://www.gravatar.com/avatar/95b5dbc23a1aea8bc95d53efd0a30edf?s=640">

    <title>Implementing Hub-Spoke network topology in Azure - Part 2</title>

    <link rel="icon" href="https://anktsrkr.github.io/favicon.png">
    

    

    <link rel="canonical" href="https://anktsrkr.github.io/post/implementing-hub-spoke-network-topology-in-azure-part-2/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://anktsrkr.github.io/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-176781214-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
    <link rel="manifest" href="https://anktsrkr.github.io/manifest.json">

    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://anktsrkr.github.io/" aria-label="Go to homepage">Ankit Sarkar | .NET Enthusiast</a>
  </div>
  
    
      <a class="header-right-picture "
         href="https://anktsrkr.github.io/#about" aria-label="Open the link: /#about">
    
    
    
      
        <img class="header-picture" src="https://www.gravatar.com/avatar/95b5dbc23a1aea8bc95d53efd0a30edf?s=90" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://anktsrkr.github.io/#about" aria-label="Read more about the author">
          <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/95b5dbc23a1aea8bc95d53efd0a30edf?s=110" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Ankit Sarkar | .NET Enthusiast</h4>
        
          <h5 class="sidebar-profile-bio"><strong>Technical Architect, Microsoft Certified Azure Solutions Architect Expert</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://anktsrkr.github.io/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://anktsrkr.github.io/categories" title="Categories">
    
      <i class="sidebar-button-icon fas fa-lg fa-bookmark" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://anktsrkr.github.io/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://anktsrkr.github.io/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://anktsrkr.github.io/about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/anktsrkr" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.linkedin.com/in/ankit-sarkar/" target="_blank" rel="noopener" title="Linkedin">
    
      <i class="sidebar-button-icon fab fa-lg fa-linkedin" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Linkedin</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/ankt_srkr" target="_blank" rel="noopener" title="Twitter">
    
      <i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://anktsrkr.github.io/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="5"
        class="
               hasCoverMetaIn
               ">
        <article class="post" id="top">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title">
      Implementing Hub-Spoke network topology in Azure - Part 2
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2020-09-08T01:00:00&#43;05:30">
        
  September 8, 2020

      </time>
    
    
  
  
    <span>in</span>
    
      <a class="category-link" href="https://anktsrkr.github.io/categories/cloud">Cloud</a>, 
    
      <a class="category-link" href="https://anktsrkr.github.io/categories/azure-architecture">Azure architecture</a>, 
    
      <a class="category-link" href="https://anktsrkr.github.io/categories/hub-spoke-topology">Hub-Spoke Topology</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p>Hi Everyone!</p>
<p>This post is continuation of how to series about Hub-Spoke network topology in Azure. Over the time, I will update this page with links to individual posts :</p>
<p><a href="https://anktsrkr.github.io/post/connect-azure-with-your-on-prem-network-part-1">Connect an on-premises network to a Microsoft Azure - Part 1</a></p>
<p><a href="https://anktsrkr.github.io/post/connect-azure-with-your-on-prem-network-part-2">Connect an on-premises network to a Microsoft Azure - Part 2</a></p>
<p><a href="https://anktsrkr.github.io/post/implementing-hub-spoke-network-topology-in-azure-part-1">Implementing Hub-Spoke network topology in Azure - Part 1</a></p>
<p><em>This Post - Implementing Hub-Spoke network topology in Azure - Part 2</em></p>
<p><a href="https://anktsrkr.github.io/post/introducing-azure-firewall-in-hub-spoke-network-topology-in-azure">Introducing Azure Firewall in Hub-Spoke network topology in Azure</a></p>
<p><a href="https://anktsrkr.github.io/post/implementing-azure-firewall-in-hub-spoke-network-topology-in-azure">Implementing Azure Firewall in Hub-Spoke network topology in Azure</a></p>
<p>Now, we know the context of this topology and architecture let&rsquo;s start to implement it. In this post, I am going to use azure powershell module to create all azure resources.</p>
<p>In my <a href="https://anktsrkr.github.io/post/connect-azure-with-your-on-prem-network-part-2/">second post</a> of this series we have already created <code>hub-vnet</code>.</p>
<p>Let&rsquo;s create Spoke 1 Virtual Network(<code>spoke1-vnet</code>), with address space <code>10.20.0.0/19</code>. We will also create a subnet <code>WorkloadSubnet</code> under Spoke1 virtual network with address space <code>10.20.1.0/24</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">$LocationName = <span style="color:#e6db74">&#34;centralindia&#34;</span>
$ResourceGroupName = <span style="color:#e6db74">&#34;network-sandbox&#34;</span>
$vnetName = <span style="color:#e6db74">&#34;spoke1-vnet&#34;</span>
$defaultSubnet = <span style="color:#e6db74">&#34;WorkloadSubnet&#34;</span>
$vnetAddressSpace = <span style="color:#e6db74">&#34;10.20.0.0/19&#34;</span>
$subnetvnetAddressSpace = <span style="color:#e6db74">&#34;10.20.1.0/24&#34;</span>

$virtualNetwork = New-AzVirtualNetwork `
                     -ResourceGroupName $ResourceGroupName `
                     -Location $LocationName `
                     -Name $vnetName `
                     -AddressPrefix $vnetAddressSpace

$subnetConfig = Add-AzVirtualNetworkSubnetConfig `
                   -Name $defaultSubnet `
                   -AddressPrefix $subnetvnetAddressSpace `
                   -VirtualNetwork $virtualNetwork


$virtualNetwork = $virtualNetwork | Set-AzVirtualNetwork</code></pre></div>
<p>Please note, by default DDoS protection plan as Basic is selected, but it is highly recommended to enable DDoS protection plan for your production environment and this is applicable for all of your virtual networks.</p>
<p>Next create Spoke 2 Virtual Network(<code>spoke2-vnet</code>), with address space <code>10.30.0.0/19</code>. We will also create a subnet <code>WorkloadSubnet</code> under Spoke1 virtual network with address space <code>10.30.1.0/24</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">$LocationName = <span style="color:#e6db74">&#34;centralindia&#34;</span>
$ResourceGroupName = <span style="color:#e6db74">&#34;network-sandbox&#34;</span>
$vnetName = <span style="color:#e6db74">&#34;spoke2-vnet&#34;</span>
$defaultSubnet = <span style="color:#e6db74">&#34;WorkloadSubnet&#34;</span>
$vnetAddressSpace = <span style="color:#e6db74">&#34;10.30.0.0/19&#34;</span>
$subnetvnetAddressSpace =<span style="color:#e6db74">&#34;10.30.1.0/24&#34;</span>

$virtualNetwork = New-AzVirtualNetwork `
                     -ResourceGroupName $ResourceGroupName `
                     -Location $LocationName `
                     -Name $vnetName `
                     -AddressPrefix $vnetAddressSpace

$subnetConfig = Add-AzVirtualNetworkSubnetConfig `
                   -Name $defaultSubnet `
                   -AddressPrefix $subnetvnetAddressSpace `
                   -VirtualNetwork $virtualNetwork

$virtualNetwork = $virtualNetwork | Set-AzVirtualNetwork</code></pre></div>
<p>Two virtual networks can not talk to each other, so by default <code>hub-vnet</code> will not be able to connect with <code>spoke1-vnet</code> and <code>spoke2-vnet</code>. So, to make it work we need to enable vnet-peering between hub and spokes.</p>
<p>Let&rsquo;s create vnet peering between hub and spokes:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">$hubvnetName = <span style="color:#e6db74">&#34;hub-vnet&#34;</span>
$hubVnet = Get-AzVirtualNetwork `
              -Name $hubvnetName

$spoke1vnetName = <span style="color:#e6db74">&#34;spoke1-vnet&#34;</span>
$spoke1Vnet = Get-AzVirtualNetwork `
                 -Name $spoke1vnetName

$spoke2vnetName = <span style="color:#e6db74">&#34;spoke2-vnet&#34;</span>
$spoke2Vnet = Get-AzVirtualNetwork `
                 -Name $spoke2vnetName


<span style="color:#75715e"># Peer Hub to Spoke 1.</span>
Add-AzVirtualNetworkPeering -Name <span style="color:#e6db74">&#39;LinkHubToSpoke1&#39;</span> `
                            -VirtualNetwork $hubVnet `
                            -RemoteVirtualNetworkId $spoke1Vnet.Id

<span style="color:#75715e"># Peer Spoke 1 to Hub.</span>
Add-AzVirtualNetworkPeering -Name <span style="color:#e6db74">&#39;LinkSpoke1ToHub&#39;</span> `
                            -VirtualNetwork $spoke1Vnet `
                            -RemoteVirtualNetworkId $hubVnet.Id

<span style="color:#75715e"># Peer Hub to Spoke 2.</span>
Add-AzVirtualNetworkPeering -Name <span style="color:#e6db74">&#39;LinkHubToSpoke2&#39;</span> `
                            -VirtualNetwork $hubVnet `
                            -RemoteVirtualNetworkId $spoke2Vnet.Id

<span style="color:#75715e"># Peer Spoke 2 to Hub.</span>
Add-AzVirtualNetworkPeering -Name <span style="color:#e6db74">&#39;LinkSpoke2ToHub&#39;</span> `
                            -VirtualNetwork $spoke2Vnet `
                            -RemoteVirtualNetworkId $hubVnet.Id</code></pre></div>
<blockquote>
<p><strong><em>NOTE:</em></strong>  You can also provide resource id if you do not have read access to the virtual network or subscription you wish to peer with.</p>
</blockquote>
<p>Once done, peering status should show as connected :</p>
<p><img src="https://anktsrkr.github.io/images/hub-spoke/hub-to-spoke1-peering-connected.jpg" alt="hub-vnet to spoke1-vnet peering connected"></p>
<p>The interesting part is I have created peering between hub and spokes but not between spoke1 and spoke2, so spoke1 and spoke2 can not communicate with each other. you can ask me, can&rsquo;t we create peering between them? Yes! you can but you should not, I will try to explain the reason in next part and will show you how communication will be done between spokes if needed.</p>
<p>Now for testing purpose, we are going to create JumpBox with IIS enabled in 3 different virtual network. None of these virtual machine will have public ip also no ports are open from NSG except the communication within VNet.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"> 
<span style="color:#75715e"># Create Virtual Machine</span>
$LocationName = Read-Host `
                    -Prompt <span style="color:#e6db74">&#39;Enter Location&#39;</span>
$ResourceGroupName = Read-Host `
                         -Prompt <span style="color:#e6db74">&#39;Enter Resource Group Name&#39;</span>

$VMName = Read-Host `
              -Prompt <span style="color:#e6db74">&#39;Enter Virtual Machine Name&#39;</span>
$ComputerName = $VMName
$VMSize = <span style="color:#e6db74">&#34;Standard_B1ms&#34;</span>

$NetworkName = Read-Host `
                   -Prompt <span style="color:#e6db74">&#39;Enter Virtual Network Name&#39;</span>
$SubnetName = Read-Host `
                  -Prompt <span style="color:#e6db74">&#39;Enter Subnet Name&#39;</span>
 
$NICName = <span style="color:#e6db74">&#34;</span>$($VMName)<span style="color:#e6db74">-Nic&#34;</span>

$rdpRule = New-AzNetworkSecurityRuleConfig `
              -Name Rdp-Rule `
              -Description <span style="color:#e6db74">&#34;Allow RDP&#34;</span> `
              -Access Allow `
              -Protocol Tcp `
              -Direction Inbound `
              -Priority 1000 `
              -SourceAddressPrefix Internet `
              -SourcePortRange * `
              -DestinationAddressPrefix * `
              -DestinationPortRange 3389

$networkSecurityGroup = New-AzNetworkSecurityGroup `
                           -ResourceGroupName $ResourceGroupName `
                           -Location $LocationName `
                           -Name <span style="color:#e6db74">&#34;</span>$($VMName)<span style="color:#e6db74">-Nsg&#34;</span> `
                           -SecurityRules $rdpRule

$Vnet = Get-AzVirtualNetwork `
            -Name $NetworkName
$SingleSubnet = Set-AzVirtualNetworkSubnetConfig `
                   -VirtualNetwork $Vnet `
                   -Name $SubnetName `
                   -NetworkSecurityGroup $networkSecurityGroup

$Vnet = Set-AzVirtualNetwork `
           -VirtualNetwork $VNET

$SingleSubnet = Get-AzVirtualNetworkSubnetConfig `
                   -VirtualNetwork $Vnet `
                   -Name $SubnetName `

$NIC = Get-AzNetworkInterface `
          -Name $NICName
$PipRequired = Read-Host `
                   -Prompt <span style="color:#e6db74">&#39;Do you want to enable public ip for this virtual machine? (Press Y to Yes)&#39;</span>

<span style="color:#66d9ef">if</span>($PipRequired <span style="color:#f92672">-eq</span> <span style="color:#e6db74">&#34;Y&#34;</span>){
    $Pip = New-AzPublicIpAddress `
              -ResourceGroupName $ResourceGroupName `
              -Location $LocationName `
              -AllocationMethod Dynamic `
              -Sku Basic `
              -Name <span style="color:#e6db74">&#34;</span>$($VMName)<span style="color:#e6db74">-PublicIp&#34;</span>

$ipconfig = New-AzNetworkInterfaceIpConfig `
               -Name <span style="color:#e6db74">&#34;</span>$($VMName)<span style="color:#e6db74">-IpConfig&#34;</span> `
               -Subnet $SingleSubnet -PublicIpAddress $Pip
}
<span style="color:#66d9ef">else</span> {
$ipconfig = New-AzNetworkInterfaceIpConfig `
               -Name <span style="color:#e6db74">&#34;</span>$($VMName)<span style="color:#e6db74">-IpConfig&#34;</span> `
               -Subnet $SingleSubnet
}

$NIC = New-AzNetworkInterface `
          -Name $NICName `
          -ResourceGroupName $ResourceGroupName `
          -Location $LocationName `
          -IpConfiguration $ipconfig

$Credential = Get-Credential `
                 -Message <span style="color:#e6db74">&#34;Enter a username and password for the virtual machine&#34;</span>

$VirtualMachine = New-AzVMConfig `
                     -VMName $VMName `
                     -VMSize $VMSize

$VirtualMachine = Set-AzVMBootDiagnostic `
                     -VM $VirtualMachine `
                     -Disable

$VirtualMachine = Set-AzVMOperatingSystem `
                     -VM $VirtualMachine `
                     -Windows `
                     -ComputerName $ComputerName `
                     -Credential $Credential `
                     -ProvisionVMAgent `
                     -EnableAutoUpdate

$VirtualMachine = Add-AzVMNetworkInterface `
                     -VM $VirtualMachine `
                     -Id $NIC.Id
$VirtualMachine = Set-AzVMSourceImage `
                     -VM $VirtualMachine `
                     -PublisherName <span style="color:#e6db74">&#39;MicrosoftWindowsServer&#39;</span> `
                     -Offer <span style="color:#e6db74">&#39;WindowsServer&#39;</span> `
                     -Skus <span style="color:#e6db74">&#39;2019-Datacenter&#39;</span> `
                     -Version latest
$VirtualMachine = Set-AzVMOSDisk `
                     -VM $VirtualMachine `
                     -Name <span style="color:#e6db74">&#34;</span>$($VMName)<span style="color:#e6db74">-OsDisk&#34;</span> `
                     -StorageAccountType <span style="color:#e6db74">&#34;Standard_LRS&#34;</span> `
                     -Windows `
                     -DiskSizeInGB 127 `
                     -CreateOption FromImage 

New-AzVM `
   -ResourceGroupName $ResourceGroupName `
   -Location $LocationName `
   -VM $VirtualMachine `
   -Verbose


<span style="color:#75715e"># Install IIS</span>
$PublicSettings = <span style="color:#e6db74">&#39;{&#34;commandToExecute&#34;:&#34;powershell Add-WindowsFeature Web-Server&#34;}&#39;</span>

Set-AzVMExtension `
        -ExtensionName <span style="color:#e6db74">&#34;IIS&#34;</span> `
        -ResourceGroupName $ResourceGroupName `
        -VMName $VMName `
        -Publisher <span style="color:#e6db74">&#34;Microsoft.Compute&#34;</span> `
        -ExtensionType <span style="color:#e6db74">&#34;CustomScriptExtension&#34;</span> -TypeHandlerVersion 1.4 `
        -SettingString $PublicSettings -Location $LocationName</code></pre></div>
<p>Once completed, Connect you VPN and let&rsquo;s see how data flows between hub to spokes from you local workspace.</p>
<h4 id="local-workspace-to-hub">Local workspace To Hub</h4>
<p>Since, we have established the VPN connection, Hub is reachable from local workspace.</p>
<p><img src="https://anktsrkr.github.io/images/hub-spoke/over-vpn-hub-reachable.jpg" alt="Hub vnet reachable from Local workspace over VPN"></p>
<h4 id="hub-to-spokes">Hub To Spokes</h4>
<p>Since, we have established the peering between Hub and spokes, these spokes are reachable from hub.</p>
<p><img src="https://anktsrkr.github.io/images/hub-spoke/hub-to-spokes-reachable.jpg" alt="Spoke vnets are reachable from Hub vnet"></p>
<h4 id="spokes-to-hub">Spokes To Hub</h4>
<p>Hub is also reachable from both spokes.</p>
<p><img src="https://anktsrkr.github.io/images/hub-spoke/spoke1-to-hub-reachable.jpg" alt="Hub vnet is reachable from Spoke 1 vnet"></p>
<p><img src="https://anktsrkr.github.io/images/hub-spoke/spoke2-to-hub-reachable.jpg" alt="Hub vnet is reachable from Spoke 2 vnet"></p>
<h4 id="local-workspace-to-spokes">Local workspace To Spokes</h4>
<p>Spokes are not reachable from local workspaces. It supposed to work right? To make it work, you need to perform some more steps -</p>
<ol>
<li>
<p>Configure all peering connections to allow forwarded traffic.</p>
</li>
<li>
<p>Configure the peering connection in the hub to allow gateway transit.
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">$resourceGroupName = <span style="color:#e6db74">&#34;network-sandbox&#34;</span>
$hubvnetName = <span style="color:#e6db74">&#34;hub-vnet&#34;</span>

<span style="color:#75715e"># Update Hub to Spoke 1.</span>
$LinkHubToSpoke1 = Get-AzVirtualNetworkPeering `
                      -VirtualNetworkName $hubvnetName `
                      -ResourceGroupName $resourceGroupName `
                      -Name <span style="color:#e6db74">&#34;LinkHubToSpoke1&#34;</span>

$LinkHubToSpoke1.AllowGatewayTransit = $True
$LinkHubToSpoke1.AllowForwardedTraffic = $True

Set-AzVirtualNetworkPeering -VirtualNetworkPeering $LinkHubToSpoke1


<span style="color:#75715e"># Update Hub to Spoke 2.</span>
$LinkHubToSpoke2 = Get-AzVirtualNetworkPeering `
                      -VirtualNetworkName $hubvnetName `
                      -ResourceGroupName $resourceGroupName `
                      -Name <span style="color:#e6db74">&#34;LinkHubToSpoke2&#34;</span>

$LinkHubToSpoke2.AllowGatewayTransit = $True
$LinkHubToSpoke2.AllowForwardedTraffic = $True

Set-AzVirtualNetworkPeering -VirtualNetworkPeering $LinkHubToSpoke2</code></pre></div></p>
</li>
<li>
<p>Configure the peering connection in each spoke to use remote gateways.
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">$resourceGroupName = <span style="color:#e6db74">&#34;network-sandbox&#34;</span>
<span style="color:#75715e"># Update Spoke 1 to Hub.</span>

$spoke1vnetName = <span style="color:#e6db74">&#34;spoke1-vnet&#34;</span>
$LinkSpoke1ToHub = Get-AzVirtualNetworkPeering `
                      -VirtualNetworkName $spoke1vnetName `
                      -ResourceGroupName $resourceGroupName `
                      -Name <span style="color:#e6db74">&#34;LinkSpoke1ToHub&#34;</span>

$LinkSpoke1ToHub.UseRemoteGateways = $True
$LinkSpoke1ToHub.AllowForwardedTraffic = $True

Set-AzVirtualNetworkPeering -VirtualNetworkPeering $LinkSpoke1ToHub

<span style="color:#75715e"># Update Spoke 2 to Hub.</span>

$spoke2vnetName = <span style="color:#e6db74">&#34;spoke2-vnet&#34;</span>
$LinkSpoke2ToHub = Get-AzVirtualNetworkPeering `
                      -VirtualNetworkName $spoke2vnetName `
                      -ResourceGroupName $resourceGroupName `
                      -Name <span style="color:#e6db74">&#34;LinkSpoke2ToHub&#34;</span>

$LinkSpoke2ToHub.UseRemoteGateways = $True
$LinkSpoke2ToHub.AllowForwardedTraffic = $True

Set-AzVirtualNetworkPeering -VirtualNetworkPeering $LinkSpoke2ToHub</code></pre></div></p>
</li>
</ol>
<p>After virtual network peering is established <strong>download and reinstall</strong> the point-to-site package so that the point-to-site clients get the updated routes to the spoke virtual network.</p>
<p><img src="https://anktsrkr.github.io/images/hub-spoke/over-vpn-spokes-reachable.jpg" alt="Hub vnet reachable from Local workspace over VPN"></p>
<h4 id="spoke-to-spoke">Spoke To Spoke</h4>
<p>Interesting! if you see the above screenshot, communication between spokes are not working. Why?  Let&rsquo;s discuss it in the <a href="https://anktsrkr.github.io/post/introducing-azure-firewall-in-hub-spoke-network-topology-in-azure/">next post</a>
!</p>
<p>Here is the updated architecture, we just implemented -</p>
<p><img src="https://anktsrkr.github.io/images/hub-spoke/implemented-hub-spoke-topology.jpg" alt="Updated architecture"></p>

              


            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://anktsrkr.github.io/tags/azure/">Azure</a>

  <a class="tag tag--primary tag--small" href="https://anktsrkr.github.io/tags/networking/">Networking</a>

                  </div>
                
              
            
            
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://anktsrkr.github.io/post/introducing-azure-firewall-in-hub-spoke-network-topology-in-azure/" data-tooltip="Introducing Azure Firewall in Hub-Spoke network topology in Azure" aria-label="NEXT: Introducing Azure Firewall in Hub-Spoke network topology in Azure">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://anktsrkr.github.io/post/implementing-hub-spoke-network-topology-in-azure-part-1/" data-tooltip="Implementing Hub-Spoke network topology in Azure - Part 1" aria-label="PREVIOUS: Implementing Hub-Spoke network topology in Azure - Part 1">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://anktsrkr.github.io/post/implementing-hub-spoke-network-topology-in-azure-part-2/" title="Share on Facebook" aria-label="Share on Facebook">
          <i class="fab fa-facebook-square" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://anktsrkr.github.io/post/implementing-hub-spoke-network-topology-in-azure-part-2/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/sharing/share-offsite/?url=https://anktsrkr.github.io/post/implementing-hub-spoke-network-topology-in-azure-part-2/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
    <li class="post-action">
      <a class="post-action-btn btn btn--default" href="#disqus_thread" aria-label="Leave a comment">
        <i class="far fa-comment"></i>
      </a>
    </li>
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


            
  
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
    <script type="text/javascript">
      var disqus_config = function() {
        this.page.url = 'https:\/\/anktsrkr.github.io\/post\/implementing-hub-spoke-network-topology-in-azure-part-2\/';
        
          this.page.identifier = '\/post\/implementing-hub-spoke-network-topology-in-azure-part-2\/'
        
      };
      (function() {
        
        
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
          document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
          return;
        }
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        var disqus_shortname = 'anktsrkr-github-io';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
  


          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2022 Ankit Sarkar | .NET Enthusiast. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://anktsrkr.github.io/post/introducing-azure-firewall-in-hub-spoke-network-topology-in-azure/" data-tooltip="Introducing Azure Firewall in Hub-Spoke network topology in Azure" aria-label="NEXT: Introducing Azure Firewall in Hub-Spoke network topology in Azure">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://anktsrkr.github.io/post/implementing-hub-spoke-network-topology-in-azure-part-1/" data-tooltip="Implementing Hub-Spoke network topology in Azure - Part 1" aria-label="PREVIOUS: Implementing Hub-Spoke network topology in Azure - Part 1">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://anktsrkr.github.io/post/implementing-hub-spoke-network-topology-in-azure-part-2/" title="Share on Facebook" aria-label="Share on Facebook">
          <i class="fab fa-facebook-square" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://anktsrkr.github.io/post/implementing-hub-spoke-network-topology-in-azure-part-2/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/sharing/share-offsite/?url=https://anktsrkr.github.io/post/implementing-hub-spoke-network-topology-in-azure-part-2/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
    <li class="post-action">
      <a class="post-action-btn btn btn--default" href="#disqus_thread" aria-label="Leave a comment">
        <i class="far fa-comment"></i>
      </a>
    </li>
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


      </div>
      
<div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <i id="btn-close-shareoptions" class="fa fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fanktsrkr.github.io%2Fpost%2Fimplementing-hub-spoke-network-topology-in-azure-part-2%2F" aria-label="Share on Facebook">
          <i class="fab fa-facebook-square" aria-hidden="true"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fanktsrkr.github.io%2Fpost%2Fimplementing-hub-spoke-network-topology-in-azure-part-2%2F" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fanktsrkr.github.io%2Fpost%2Fimplementing-hub-spoke-network-topology-in-azure-part-2%2F" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i><span>Share on Linkedin</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>


    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.gravatar.com/avatar/95b5dbc23a1aea8bc95d53efd0a30edf?s=110" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Ankit Sarkar | .NET Enthusiast</h4>
    
      <div id="about-card-bio"><strong>Technical Architect, Microsoft Certified Azure Solutions Architect Expert</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Technical Architect
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker-alt"></i>
        <br/>
        Nottingham
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://anktsrkr.github.io/images/cover.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/powershell.min.js"  crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://anktsrkr.github.io/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>


  
    <script async crossorigin="anonymous" defer integrity="sha512-gE8KAQyFIzV1C9+GZ8TKJHZS2s+n7EjNtC+IMRn1l5+WYJTHOODUM6JSjZhFhqXmc7bG8Av6XXpckA4tYhflnw==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/apache.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-EWROca+bote+7Oaaar1F6y74iZj1r1F9rm/ly7o+/FwJopbBaWtsFDmaKoZDd3QiGU2pGacBirHJNivmGLYrow==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/go.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-GDVzAn0wpx1yVtQsRWmFc6PhJiLBPdUic+h4GWgljBh904O3JU10fk9EKNpVyIoPqkFn54rgL2QBG4BmUTMpiQ==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/http.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-UgZlma8NzkrDb/NWgmLIcTrH7i/CSnLLDRFqCSNF5NGPpjKmzyM25qcoXGOup8+cDakKyaiTDd7N4dyH4YT+IA==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/less.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-lot9koe73sfXIrUvIPM/UEhuMciN56RPyBdOyZgfO53P2lkWyyXN7J+njcxIIBRV+nVDQeiWtiXg+bLAJZDTfg==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/nginx.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-Zd3e7XxHP00TD0Imr0PIfeM0fl0v95kMWuhyAS3Wn1UTSXTkz0OhtRgBAr4JlmADRgiXr4x7lpeUdqaGN8xIog==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/puppet.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-qtqDO052iXMSP+5d/aE/jMtL9vIIGvONgTJziC2K/ZIB1yEGa55WVxGE9/08rSQ62EoDifS9SWVGZ7ihSLhzMA==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/scss.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-1NmkjnEDnwwwcu28KoQF8vs3oaPFokQHbmbtwGhFfeDsQZtVFI8zW2aE9O8yMYdpdyKV/5blE4pSWw4Z/Sv97w==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/stylus.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-B2wSfruPjr8EJL6IIzQr1eAuDwrsfIfccNf/LCEdxELCgC/S/ZMt/Uvk80aD79m7IqOqW+Sw8nbkvha20yZpzg==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/swift.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-28oDiQZGKUVN6wQ7PSLPNipOcmkCALXKwOi7bnkyFf8QiMZQxG9EQoy/iiNx6Zxj2cG2SbVa4dXKigQhu7GiFw==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/yaml.min.js"></script>
  


<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightElement(block);
  });
});
</script>





<script id="setmore_script" type="text/javascript" src="https://my.setmore.com/webapp/js/src/others/setmore_iframe.js">
</script>
<script>
  if('serviceWorker' in navigator) {
      navigator.serviceWorker
          .register('/sw.js', { scope: '/' })
          .then(function(registration) {
          });

      navigator.serviceWorker
          .ready
          .then(function(registration) {
          });
  }
</script>

<a id="Setmore_button_iframe" style="position: fixed;
 right: 20px;
 bottom: 15px;
 z-index: 9998;text-decoration: none"
    href="https://booking.setmore.com/scheduleappointment/d3cbc8af-7bd5-44c1-874b-87c9d77d82be">
    <div style="background: rgb(0, 105, 255); color: rgb(255, 255, 255);
display: table-cell;
width: auto;
height: 45px;
padding: 0 30px;
border-radius: 25px;
box-shadow: rgb(0 0 0 / 25%) 0 2px 5px;
font-family: sans-serif;
text-align: center;
vertical-align: middle;
font-weight: bold;
font-size: 14px;
color: #fff;
cursor: pointer;">#TalkWithMe</div>
</a>

    
  </body>
</html>

